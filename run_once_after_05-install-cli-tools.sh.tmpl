#!/bin/bash
#
# run_once_after_05-install-cli-tools.sh.tmpl
# 安裝現代化 CLI 工具 (只在 macOS 和 Linux 執行)
#

{{- if ne .chezmoi.os "windows" }}

set -e

print_status() { echo -e "\033[0;34m[CLI-TOOLS]\033[0m $1"; }
print_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $1"; }
print_warning() { echo -e "\033[1;33m[WARNING]\033[0m $1"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }

install_tool() {
    local tool_name="$1"
    local install_cmd="$2"
    
    if ! command_exists "$tool_name"; then
        print_status "Installing $tool_name..."
        eval "$install_cmd"
        print_success "$tool_name installed"
    else
        print_success "$tool_name already installed"
    fi
}

{{- if eq .chezmoi.os "darwin" }}
# macOS - Install using Homebrew
if command_exists brew; then
    install_tool "eza" "brew install eza"
    install_tool "bat" "brew install bat"
    install_tool "fd" "brew install fd"
    install_tool "fzf" "brew install fzf"
    install_tool "zoxide" "brew install zoxide"
    install_tool "micro" "brew install micro"
    install_tool "ripgrep" "brew install ripgrep"
    install_tool "jq" "brew install jq"
    install_tool "tree" "brew install tree"
    install_tool "htop" "brew install htop"
else
    print_warning "Homebrew not found. CLI tools installation skipped."
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux - Install based on distribution
if command_exists dnf; then
    # Fedora
    install_tool "eza" "sudo dnf install -y eza"
    install_tool "bat" "sudo dnf install -y bat"
    install_tool "fd" "sudo dnf install -y fd-find"
    install_tool "fzf" "sudo dnf install -y fzf"
    install_tool "zoxide" "sudo dnf install -y zoxide"
    install_tool "micro" "sudo dnf install -y micro"
    install_tool "ripgrep" "sudo dnf install -y ripgrep"
    install_tool "jq" "sudo dnf install -y jq"
    install_tool "tree" "sudo dnf install -y tree"
    install_tool "htop" "sudo dnf install -y htop"
    
elif command_exists pacman; then
    # Arch Linux
    install_tool "eza" "sudo pacman -S --noconfirm eza"
    install_tool "bat" "sudo pacman -S --noconfirm bat"
    install_tool "fd" "sudo pacman -S --noconfirm fd"
    install_tool "fzf" "sudo pacman -S --noconfirm fzf"
    install_tool "zoxide" "sudo pacman -S --noconfirm zoxide"
    install_tool "micro" "sudo pacman -S --noconfirm micro"
    install_tool "ripgrep" "sudo pacman -S --noconfirm ripgrep"
    install_tool "jq" "sudo pacman -S --noconfirm jq"
    install_tool "tree" "sudo pacman -S --noconfirm tree"
    install_tool "htop" "sudo pacman -S --noconfirm htop"
    
elif command_exists apt-get; then
    # Ubuntu/Debian
    install_tool "bat" "sudo apt-get install -y bat"
    install_tool "fdfind" "sudo apt-get install -y fd-find"
    install_tool "fzf" "sudo apt-get install -y fzf"
    install_tool "micro" "sudo apt-get install -y micro"
    install_tool "ripgrep" "sudo apt-get install -y ripgrep"
    install_tool "jq" "sudo apt-get install -y jq"
    install_tool "tree" "sudo apt-get install -y tree"
    install_tool "htop" "sudo apt-get install -y htop"
    
    # Install eza (requires manual setup for Ubuntu/Debian)
    if ! command_exists eza; then
        print_status "Installing eza..."
        sudo mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
        sudo apt-get update
        sudo apt-get install -y eza
        print_success "eza installed"
    else
        print_success "eza already installed"
    fi
fi

# Install tools that need manual installation on Linux
if ! command_exists zoxide; then
    print_status "Installing zoxide..."
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
    print_success "zoxide installed"
fi


{{- end }}

# Install fzf-git.sh (cross-platform)
if [[ ! -d "$HOME/fzf-git.sh" ]]; then
    print_status "Installing fzf-git.sh..."
    git clone https://github.com/junegunn/fzf-git.sh.git ~/fzf-git.sh
    print_success "fzf-git.sh installed"
else
    print_success "fzf-git.sh already installed"
fi

print_success "CLI tools installation completed!"

# Show installed tool versions
print_status "Installed tool versions:"
command_exists eza && echo "  eza: $(eza --version | head -1)"
{{- if eq .chezmoi.os "linux" }}
command_exists batcat && echo "  bat: $(batcat --version)"
command_exists fdfind && echo "  fd: $(fdfind --version)"
{{- else }}
command_exists bat && echo "  bat: $(bat --version)"
command_exists fd && echo "  fd: $(fd --version)"
{{- end }}
command_exists fzf && echo "  fzf: $(fzf --version)"
command_exists zoxide && echo "  zoxide: $(zoxide --version)"
command_exists micro && echo "  micro: $(micro --version)"
command_exists rg && echo "  ripgrep: $(rg --version | head -1)"

{{- else }}

echo "Windows detected - CLI tools installation skipped (use WSL instead)"

{{- end }}