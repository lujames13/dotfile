#!/bin/bash
#
# run_once_before_02-install-terminal-wezterm.sh.tmpl
# 跨平台安裝 WezTerm
#

set -e

print_status() { echo -e "\033[0;34m[WEZTERM]\033[0m $1"; }
print_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $1"; }
print_warning() { echo -e "\033[1;33m[WARNING]\033[0m $1"; }
print_error() { echo -e "\033[0;31m[ERROR]\033[0m $1"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }

{{- if eq .chezmoi.os "darwin" }}
# macOS - Install WezTerm using Homebrew
if ! command_exists wezterm; then
    print_status "Installing WezTerm on macOS..."
    if command_exists brew; then
        brew install --cask wezterm
        print_success "WezTerm installed via Homebrew"
    else
        print_error "Homebrew not found. Please install Homebrew first."
        exit 1
    fi
else
    print_success "WezTerm already installed"
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux - Install WezTerm
if ! command_exists wezterm; then
    print_status "Installing WezTerm on Linux..."
    
    if command_exists apt-get; then
        # Ubuntu/Debian
        print_status "Installing WezTerm via apt..."
        curl -fsSL https://apt.fury.io/wez/gpg.key | sudo gpg --yes --dearmor -o /usr/share/keyrings/wezterm-fury.gpg
        echo 'deb [signed-by=/usr/share/keyrings/wezterm-fury.gpg] https://apt.fury.io/wez/ * *' | sudo tee /etc/apt/sources.list.d/wezterm.list
        sudo apt update
        sudo apt install -y wezterm
        print_success "WezTerm installed via apt"
        
    elif command_exists dnf; then
        # Fedora
        print_status "Installing WezTerm via dnf..."
        sudo dnf copr enable wezterm/wezterm-nightly
        sudo dnf install -y wezterm
        print_success "WezTerm installed via dnf"
        
    elif command_exists pacman; then
        # Arch Linux
        print_status "Installing WezTerm via pacman..."
        sudo pacman -S --noconfirm wezterm
        print_success "WezTerm installed via pacman"
        
    else
        # Fallback: AppImage
        print_status "Installing WezTerm AppImage..."
        WEZTERM_VERSION=$(curl -s https://api.github.com/repos/wez/wezterm/releases/latest | grep -Po '"tag_name": "\K[^"]*')
        wget -O ~/Applications/WezTerm.AppImage "https://github.com/wez/wezterm/releases/download/${WEZTERM_VERSION}/WezTerm-${WEZTERM_VERSION}-Ubuntu20.04.AppImage"
        chmod +x ~/Applications/WezTerm.AppImage
        
        # Create symlink for command line usage
        mkdir -p ~/.local/bin
        ln -sf ~/Applications/WezTerm.AppImage ~/.local/bin/wezterm
        print_success "WezTerm AppImage installed"
    fi
else
    print_success "WezTerm already installed"
fi

{{- else if eq .chezmoi.os "windows" }}
# Windows - Install WezTerm using winget
if ! command_exists wezterm; then
    print_status "Installing WezTerm on Windows..."
    if command_exists winget; then
        winget install --id=wez.wezterm -e
        print_success "WezTerm installed via winget"
    else
        print_error "winget not found. Please install WezTerm manually from:"
        print_error "https://github.com/wez/wezterm/releases"
        exit 1
    fi
else
    print_success "WezTerm already installed"
fi

{{- end }}

# Verify installation
if command_exists wezterm; then
    WEZTERM_VERSION=$(wezterm --version 2>/dev/null | head -1 || echo "Version detection failed")
    print_success "WezTerm installation verified: $WEZTERM_VERSION"
else
    print_warning "WezTerm installation may need a shell restart to be available in PATH"
fi

print_success "WezTerm installation completed!"